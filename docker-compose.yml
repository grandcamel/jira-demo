version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: jira-demo-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/demo.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/locations.conf:/etc/nginx/conf.d/locations.conf:ro
      - ./landing-page:/var/www/html:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx-logs:/var/log/nginx
    # Override default symlinks to /dev/stdout so logs go to actual files for promtail
    command: >
      sh -c "rm -f /var/log/nginx/access.log /var/log/nginx/error.log &&
             touch /var/log/nginx/access.log /var/log/nginx/error.log &&
             nginx -g 'daemon off;'"
    depends_on:
      - queue-manager
      - lgtm
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  queue-manager:
    build: ./queue-manager
    container_name: jira-demo-queue
    environment:
      - REDIS_URL=redis://redis:6379
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-60}
      - MAX_QUEUE_SIZE=${MAX_QUEUE_SIZE:-10}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN}
      - JIRA_EMAIL=${JIRA_EMAIL}
      - JIRA_SITE_URL=${JIRA_SITE_URL}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - OTEL_SERVICE_NAME=jira-demo-queue-manager
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://lgtm:4318
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=otlp
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./secrets:/secrets:ro
      - ./demo-container:/opt/demo-container:ro
      - ./scripts:/opt/scripts:ro
    depends_on:
      - redis
      - lgtm
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:alpine
    container_name: jira-demo-redis
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  lgtm:
    image: grafana/otel-lgtm:latest
    container_name: jira-demo-lgtm
    environment:
      - GF_SERVER_ROOT_URL=http://localhost:8080/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_AUTH_PROXY_ENABLED=true
      - GF_AUTH_PROXY_HEADER_NAME=X-WEBAUTH-USER
      - GF_AUTH_PROXY_HEADER_PROPERTY=username
      - GF_AUTH_PROXY_AUTO_SIGN_UP=true
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_PLUGINS_ENABLE_ALPHA=false
      - GF_PLUGINS_DISABLE_PLUGINS=grafana-exploretraces-app,grafana-metricsdrilldown-app,grafana-pyroscope-app
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/demo-home.json
    volumes:
      # Mount to LGTM's provisioning path (not /etc/grafana which is ignored)
      - ./observability/grafana-dashboards.yaml:/otel-lgtm/grafana/conf/provisioning/dashboards/jira-demo.yaml:ro
      - ./observability/dashboards:/var/lib/grafana/dashboards:ro
      - lgtm-data:/data
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: jira-demo-redis-exporter
    environment:
      - REDIS_ADDR=redis://redis:6379
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  promtail:
    image: grafana/promtail:latest
    container_name: jira-demo-promtail
    volumes:
      - ./observability/promtail-config.yaml:/etc/promtail/config.yml:ro
      - nginx-logs:/var/log/nginx:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - lgtm
    restart: unless-stopped
    networks:
      - demo-network
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

networks:
  demo-network:
    external: true
    name: demo-telemetry-network

volumes:
  redis-data:
  lgtm-data:
  nginx-logs:
